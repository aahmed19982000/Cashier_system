{% extends 'base.html' %}
{% load static %}

{% block title %}Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - ÙØ·Ø§Ø·Ø±ÙŠ Ø§Ù„Ø¨Ø±ÙƒØ©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
<style>
    /* Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ø®ØªÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¯ÙØ¹ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØªØ± */
    .cart-sidebar {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 20px);
        position: sticky;
        top: 10px;
    }

    #cartItemsContainer {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
        min-height: 200px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .btn-return-action {
        background-color: #f39c12;
        color: white !important;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-left: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: 0.3s;
    }
    .btn-return-action:hover {
        background-color: #e67e22;
        transform: translateY(-2px);
    }

    /* ØªÙ…ÙŠÙŠØ² Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« */
    .order-id.updated {
        color: #27ae60;
        font-weight: bold;
        transition: 0.5s;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <div class="search-container">
                <i class="search-icon">ğŸ”</i>
                <input type="text" id="posSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù...">
            </div>
            <div class="user-actions">
                <a href="{% url 'orders' %}" class="btn-return-action">ğŸ”„ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹</a>
                <button class="action-circle" title="Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª">ğŸ””</button>
                <button class="action-circle" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
            </div>
        </header>

        <nav class="categories-container">
            <div class="cat-track">
                <button class="cat-pill active" data-filter="all">â­ Ø§Ù„ÙƒÙ„</button>
                {% for category in categories %}
                    <button class="cat-pill" data-filter="{{ category.id }}">{{ category.name }}</button>
                {% endfor %}
            </div>
        </nav>

        <div class="products-layout" id="productsGrid">
            {% for product in products %}
            <div class="product-item" data-category="{{ product.Category.id }}">
                <div class="product-main-info">
                    <h3 class="product-title">{{ product.name }}</h3>
                    <div class="product-price-tag">{{ product.price }} <span>Ø¬.Ù…</span></div>
                </div>
                <p class="product-desc">{{ product.description|default:"-" }}</p>
                <button class="add-to-cart-btn" 
                        data-id="{{ product.id }}" 
                        data-name="{{ product.name }}" 
                        data-price="{{ product.price }}">
                    Ø¥Ø¶Ø§ÙØ© +
                </button>
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header">
            <div class="cart-meta">
                <h2>Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                <span class="order-id" id="displayOrderId">#ORD-Ø¬Ø¯ÙŠØ¯</span>
            </div>
            <button class="clear-cart" id="clearCart">ğŸ—‘ï¸</button>
        </div>

        <div class="cart-items-container" id="cartItemsContainer">
            <div class="empty-cart-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
        </div>

        <div class="cart-summary-footer">
            <div class="billing-details">
                <div class="bill-row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span> <span id="subtotalDisplay">0.00 Ø¬.Ù…</span></div>
                <div class="bill-row"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (0%)</span> <span id="taxDisplay">0.00 Ø¬.Ù…</span></div>
                <div class="bill-row grand-total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span> <span id="totalDisplay">0.00 Ø¬.Ù…</span></div>
            </div>

            <div class="checkout-grid">
                <button class="check-btn visa">ğŸ’³ ÙÙŠØ²Ø§</button>
                <button class="check-btn cash" id="cashCheckout">ğŸ’µ Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</button>
            </div>
        </div>
    </aside>
</div>

<script>
let cart = [];

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ù„Ø©
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-to-cart-btn')) {
        const btn = e.target;
        const product = {
            id: btn.dataset.id,
            name: btn.dataset.name,
            price: parseFloat(btn.dataset.price),
            qty: 1
        };
        const existing = cart.find(item => item.id === product.id);
        if (existing) existing.qty++;
        else cart.push(product);
        renderCart();
    }
});

// Ø±Ø³Ù… ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø©
function renderCart() {
    const container = document.getElementById('cartItemsContainer');
    container.innerHTML = '';
    let subtotal = 0;

    if (cart.length === 0) {
        container.innerHTML = '<div class="empty-cart-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
    }

    cart.forEach(item => {
        subtotal += (item.price * item.qty);
        container.innerHTML += `
            <div class="cart-card">
                <div class="cart-card-info">
                    <h4>${item.name}</h4>
                    <div class="price-calc">${item.price} Ã— ${item.qty} = <strong>${(item.price * item.qty).toFixed(2)} Ø¬.Ù…</strong></div>
                </div>
                <div class="cart-card-actions">
                    <div class="stepper">
                        <button onclick="updateQty('${item.id}', -1)">âˆ’</button>
                        <input type="number" value="${item.qty}" readonly>
                        <button onclick="updateQty('${item.id}', 1)">+</button>
                    </div>
                </div>
            </div>`;
    });

    const tax = subtotal * 0;
    const total = subtotal + tax;
    document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2) + ' Ø¬.Ù…';
    document.getElementById('taxDisplay').innerText = tax.toFixed(2) + ' Ø¬.Ù…';
    document.getElementById('totalDisplay').innerText = total.toFixed(2) + ' Ø¬.Ù…';
    
    container.scrollTop = container.scrollHeight;
}

window.updateQty = function(id, change) {
    const item = cart.find(i => i.id === id);
    if (item) {
        item.qty += change;
        if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
        renderCart();
    }
}

document.getElementById('clearCart').onclick = () => { if(confirm('ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©ØŸ')) { cart = []; renderCart(); } };

// Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
document.getElementById('posSearch').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        const name = item.querySelector('.product-title').innerText.toLowerCase();
        item.style.display = name.includes(term) ? 'flex' : 'none';
    });
});

document.querySelectorAll('.cat-pill').forEach(pill => {
    pill.onclick = function() {
        document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        const filter = this.dataset.filter;
        document.querySelectorAll('.product-item').forEach(item => {
            item.style.display = (filter === 'all' || item.dataset.category === filter) ? 'flex' : 'none';
        });
    };
});

// Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø« Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
document.getElementById('cashCheckout').addEventListener('click', function() {
    if (cart.length === 0) {
        alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
        return;
    }

    const total = parseFloat(document.getElementById('totalDisplay').innerText);
    const orderDisplay = document.getElementById('displayOrderId');

    fetch("{% url 'cash_checkout' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ cart: cart, total: total })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success'){
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            orderDisplay.innerText = "#ORD-" + data.order_id;
            orderDisplay.classList.add('updated');

            alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: ' + data.order_id);
            
            cart = [];
            renderCart();

            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            setTimeout(() => {
                orderDisplay.classList.remove('updated');
                orderDisplay.innerText = "#ORD-Ø¬Ø¯ÙŠØ¯";
            }, 5000);

        } else {
            alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
        }
    })
    .catch(err => alert('Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'));
});
</script>
{% endblock %}